<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="webapp.mapper.OrderMapper">

    <!-- 定义 resultMap 映射 -->
    <resultMap id="OrderMap" type="Order">
        <id property="orderId" column="order_id"/>
        <id property="userId" column="user_id"/>
        <id property="orderDate" column="order_date"/>
        <id property="orderAmount" column="order_amount"/>
        <id property="paymentStatus" column="payment_status"/>
        <id property="productId" column="product_id"/>
        <id property="productInfo" column="product_info" typeHandler="webapp.handler.JsonHandler"/>
    </resultMap>

    <insert id="submit" parameterType="Order">
        insert into `order` (order_id, user_id, product_id, product_info, order_date, payment_status, order_amount)
        values (#{orderId}, #{userId}, #{productId}, #{productInfo, typeHandler=webapp.handler.JsonHandler},
                CURRENT_TIMESTAMP, 0, #{orderAmount})
    </insert>

    <select id="selectOrderByPage" resultType="Order" resultMap="OrderMap">
        select * from `order` where 1=1
        <if test="name != null and name.trim().length() > 0">
            and nickname LIKE CONCAT('%', #{nickname}, '%')
        </if>
        <if test="phone != null and phone.trim().length() > 0">
            and tel_number LIKE CONCAT('%', #{phone}, '%')
        </if>
        <if test="sex != null and sex.trim().length() > 0">
            and sex = #{sex}
        </if>
        order by order_date desc
    </select>

    <select id="getDetail" resultMap="OrderMap">
        select *
        from `order`
        where order_id = #{orderId}
    </select>

    <update id="doPay">
        update `order` o LEFT JOIN user u
        on o.user_id = u.id
            set o.payment_status = 1, u.gold = COALESCE (u.gold, 0) - #{amount}
        where order_id = #{orderId}
    </update>

</mapper>